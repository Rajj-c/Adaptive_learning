<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GENESIS AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b2f4f; /* Deep sea blue */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231a486d' fill-opacity='0.1'%3E%3Cpath d='M36 34.25l-.014.014L36 34.25zm-2.828 2.828l.014-.014L33.172 37.078zm3.535-3.536l.014-.014L36.697 33.542zm-3.535 3.536l.014-.014L33.172 37.078zM18 16.25l-.014.014L18 16.25zm-2.828 2.828l.014-.014L15.172 19.078zm3.535-3.536l.014-.014L18.697 15.542zm-3.535 3.536l.014-.014L15.172 19.078z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            background-size: 15px 15px;
            transition: background-color 0.3s ease;
        }

        h1, h2, h3 {
            font-family: 'Bebas Neue', cursive;
        }

        .container {
            max-width: 900px;
            margin: auto;
        }
        .card {
            background-color: #f5f5dc; /* Parchment-like */
            border: 2px solid #5a3c1e;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.08);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-flip {
            animation: flip 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        @keyframes flip {
            0% { transform: rotateY(0); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0); }
        }
        .loader-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: auto;
        }
        .straw-hat {
            width: 100%;
            height: 100%;
            animation: spin-and-bounce 2s ease-in-out infinite;
        }
        .jolly-roger {
            width: 80%;
            height: 80%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes spin-and-bounce {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(90deg); }
            50% { transform: translateY(0) rotate(180deg); }
            75% { transform: translateY(-20px) rotate(270deg); }
            100% { transform: translateY(0) rotate(360deg); }
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.5; }
            50% { transform: translate(-50%, -50%) scale(1.0); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.5; }
        }
        .answer-btn {
            background-color: #c0845a;
            color: white;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .answer-btn.correct {
            background-color: #ffd700; /* Treasure gold */
            color: #1f2937;
        }
        .answer-btn.incorrect {
            background-color: #dc2626; /* Jolly Roger red */
            color: white;
        }
        .answer-btn:not(.correct):not(.incorrect):hover {
            background-color: #a06e4a;
        }
        /* Custom styles for tree-like structure */
        .tree ul {
            list-style: none;
            padding-left: 1.5rem;
        }
        .tree li {
            position: relative;
            padding-left: 1rem;
            margin-top: 0.5rem;
        }
        .tree li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 1rem;
            height: 1px;
            background: #5a3c1e;
        }
        .tree li::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0.5rem;
            bottom: -0.5rem;
            width: 1px;
            background: #5a3c1e;
        }
        .tree li:last-child::after {
            height: 0.5rem;
        }
        .tree-root::before, .tree-root::after {
            display: none;
        }
        #chat-window {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #5a3c1e;
            border-radius: 1rem;
            background-color: #f5f5dc;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .chat-message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
        }
        .user-message {
            background-color: #3b82f6; /* Ocean Blue */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }
        .ai-message {
            background-color: #1f2937; /* Pirate Black */
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }
        .score-bar-container {
            width: 100%;
            height: 2rem;
            background-color: #5a3c1e; /* Brown */
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .score-bar {
            height: 100%;
            background-color: #ffd700; /* Gold */
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">
    <div class="container p-6">
        <!-- Main Content Area -->
        <div id="main-content" class="text-center">

            <!-- Login/Signup Screen -->
            <div id="login-screen" class="fade-in">
                <div class="card p-8 md:p-12 relative overflow-hidden">
                    <h2 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">JOIN THE CREW!</h2>
                    <p class="text-lg text-gray-600 mb-8">Log in or sign up to save your progress and set sail.</p>
                    
                    <input type="email" id="login-email" class="w-full p-4 text-gray-700 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Email">
                    <input type="password" id="login-password" class="w-full p-4 text-gray-700 bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Password">

                    <div id="login-error-message" class="text-red-500 text-sm mb-4 hidden"></div>
                    
                    <a href="#" id="forgot-password-link" class="text-sm text-blue-600 hover:underline mb-4 inline-block">Forgot Password?</a>

                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition transform hover:scale-105">
                            Log In
                        </button>
                        <button id="signup-btn" class="w-full bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-700 transition transform hover:scale-105">
                            Sign Up
                        </button>
                    </div>
                </div>
            </div>

            <!-- Welcome/Input Screen -->
            <div id="welcome-screen" class="hidden fade-in">
                <div class="card p-8 md:p-12 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Welcome</h1>
                        <button id="logout-btn" class="text-gray-600 hover:text-red-500 transition">Log Out</button>
                    </div>
                    <p class="text-lg text-gray-600 mb-2">Logged in as: <span id="user-id-display" class="font-semibold text-blue-600"></span></p>
                    <p class="text-lg text-gray-600 mb-8">Your personalized, adaptive learning companion. Upload your material below to get started.</p>
                    <input type="file" id="material-upload" accept=".txt,.md" class="w-full text-gray-700 bg-gray-50 border border-gray-300 rounded-xl p-4 mb-4">
                    <p class="text-sm text-gray-500 mb-4">Or paste your course material here:</p>
                    <textarea id="curriculum-input" class="w-full h-48 p-4 text-gray-700 bg-gray-50 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Paste your course material here..."></textarea>
                    <button id="start-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition transform hover:scale-105">
                        Start Learning
                    </button>
                </div>
            </div>
            
            <!-- Topic Selection Screen -->
            <div id="topic-screen" class="hidden fade-in">
                <div class="card p-8 md:p-12 relative">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl md:text-4xl font-bold text-gray-800">What to learn about?</h2>
                        <button id="logout-btn-topic" class="text-gray-600 hover:text-red-500 transition">Log Out</button>
                    </div>
                    <p class="text-lg text-gray-600 mb-4">The AI has analyzed your material. Enter a specific topic to get a detailed explanation and a tailored quiz.</p>
                    <div class="flex flex-col md:flex-row items-center md:space-x-4 mb-6">
                        <label for="learning-speed" class="text-gray-700 text-sm font-medium whitespace-nowrap">My learning speed is:</label>
                        <select id="learning-speed" class="w-full md:w-auto p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2 md:mt-0">
                            <option value="slow">Slow & Steady</option>
                            <option value="standard" selected>Standard Pace</option>
                        </select>
                    </div>
                    <textarea id="topic-input" class="w-full h-32 p-4 text-gray-700 bg-gray-50 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="e.g., 'The role of photosynthesis in plant life' or 'Newton's laws of motion'"></textarea>
                    <button id="get-explanation-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-700 transition transform hover:scale-105">
                        Get Explanation & Start Quiz
                    </button>
                </div>
            </div>

            <!-- Loading Screen -->
            <div id="loading-screen" class="hidden fade-in text-center">
                <div class="card p-12 relative overflow-hidden">
                    <div class="loader-container mx-auto mb-6">
                        <!-- Luffy's Straw Hat SVG -->
                        <svg class="straw-hat" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50 0C32.11 0 17.5 13.56 17.5 30.25V42.5C17.5 54.49 26.51 64.25 38.5 64.25H61.5C73.49 64.25 82.5 54.49 82.5 42.5V30.25C82.5 13.56 67.89 0 50 0ZM50 7.5C64.9 7.5 77.5 18.23 77.5 30.25V42.5C77.5 51.78 70.28 59.25 61.5 59.25H38.5C29.72 59.25 22.5 51.78 22.5 42.5V30.25C22.5 18.23 35.1 7.5 50 7.5Z" fill="#F8C437"/>
                            <path d="M50 20C40.67 20 33.15 27.27 33.15 35.25C33.15 39.51 34.62 43.43 37.15 46.5L43.83 54.74C46.85 58.42 53.15 58.42 56.17 54.74L62.85 46.5C65.38 43.43 66.85 39.51 66.85 35.25C66.85 27.27 59.33 20 50 20Z" fill="#CE4D00"/>
                        </svg>
                        <!-- Jolly Roger SVG -->
                        <svg class="jolly-roger" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50 10C27.91 10 10 27.91 10 50C10 72.09 27.91 90 50 90C72.09 90 90 72.09 90 50C90 27.91 72.09 10 50 10Z" fill="#1F2937"/>
                            <path d="M65 40L60 45L65 50L60 55L65 60L55 65L50 60L45 65L35 60L40 55L35 50L40 45L35 40L45 35L50 40L55 35L65 40Z" fill="#DC2626"/>
                        </svg>
                    </div>
                    <p class="text-xl font-medium text-gray-700">Generating your learning path...</p>
                    <p class="text-sm text-gray-500 mt-2">This may take a moment. The AI is learning from your material.</p>
                </div>
            </div>

            <!-- Explanation Screen with Chatbot -->
            <div id="explanation-screen" class="hidden fade-in">
                <div class="card p-8 md:p-12 mb-6 text-left flex flex-col lg:flex-row lg:space-x-8">
                    <div class="flex justify-between items-center w-full mb-4">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Topic Summary</h2>
                        <button id="logout-btn-explanation" class="text-gray-600 hover:text-red-500 transition">Log Out</button>
                    </div>
                    <!-- Left side: Explanation -->
                    <div class="lg:w-2/3 mb-8 lg:mb-0">
                        <div id="explanation-text" class="text-base text-gray-700 leading-relaxed max-h-[400px] overflow-y-auto mb-6 p-4 bg-gray-50 rounded-lg">
                            <!-- Explanation will be populated here by JS -->
                        </div>
                    </div>
                    <!-- Right side: Chatbot -->
                    <div class="lg:w-1/3 flex flex-col">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">AI Tutor</h3>
                        <div id="chat-window" class="flex-grow mb-4"></div>
                        <div class="flex">
                            <input type="text" id="chat-input" placeholder="Ask a question..." class="flex-grow p-3 text-gray-700 bg-gray-50 border border-gray-300 rounded-xl rounded-r-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="send-chat-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl rounded-l-none hover:bg-blue-700 transition">Send</button>
                        </div>
                    </div>
                </div>
                <button id="start-quiz-btn" class="w-full bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-700 transition transform hover:scale-105">
                    Start Quiz
                </button>
            </div>

            <!-- Game Screen -->
            <div id="game-screen" class="hidden fade-in">
                <div class="card p-8 md:p-12 mb-6 relative">
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-gray-600 text-sm">
                            <span id="difficulty-text" class="font-medium text-blue-600 uppercase"></span>
                        </div>
                        <div class="text-gray-600 text-sm">Score: <span id="score-text" class="font-bold text-green-600">0</span> / <span id="total-questions">10</span></div>
                    </div>
                    <h2 id="question-text" class="text-2xl md:text-3xl font-bold text-gray-800 mb-8 card-flip"></h2>
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Options will be populated here by JS -->
                    </div>
                    <button id="logout-btn-game" class="absolute top-4 right-4 text-gray-600 hover:text-red-500 transition">Log Out</button>
                </div>
                <button id="next-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition transform hover:scale-105 hidden">
                    Next Question
                </button>
            </div>

            <!-- Quiz Results Screen -->
            <div id="quiz-results-screen" class="hidden fade-in">
                <div class="card p-8 md:p-12 relative overflow-hidden">
                    <div class="flex justify-between items-center w-full mb-4">
                        <h2 class="text-3xl md:text-4xl font-bold text-gray-800">Quiz Results</h2>
                        <button id="logout-btn-results" class="text-gray-600 hover:text-red-500 transition">Log Out</button>
                    </div>
                    <div class="flex flex-col items-center justify-center mb-6">
                        <div id="final-score-text" class="text-5xl font-extrabold text-blue-600 mr-4"></div>
                        <canvas id="score-chart" width="400" height="200" class="mt-4"></canvas>
                    </div>
                    <h3 id="performance-message" class="text-xl font-semibold mb-4 text-gray-800"></h3>
                    <div id="suggestions" class="text-left text-gray-700">
                        <!-- Suggestions will be populated here by JS -->
                    </div>
                    <button id="start-over-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition transform hover:scale-105 mt-8">
                        Start a New Topic
                    </button>
                </div>
            </div>

            <!-- Modal for alerts/messages -->
            <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
                <div class="card p-8 max-w-sm w-full text-center">
                    <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4"></h3>
                    <p id="modal-message" class="text-gray-600 mb-6"></p>
                    <button id="modal-ok-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700 transition">OK</button>
                </div>
            </div>

        </div>
    </div>
    
    <footer class="mt-8 text-center text-gray-400 text-sm p-4">
        <p class="mb-2">Built by Team Pirates</p>
        <p>C. Rajeswar, B. Maateja Naik, P. Haswanth, V. Guru Mohith, M. Pavan</p>
    </footer>

    <!-- Firebase SDKs and App Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
          apiKey: "AIzaSyAvYfJXNM4R36KJNjmAzXI89u5J-0llZRg",
          authDomain: "adaptive-learning-ee646.firebaseapp.com",
          projectId: "adaptive-learning-ee646",
          storageBucket: "adaptive-learning-ee646.firebasestorage.app",
          messagingSenderId: "1057323137664",
          appId: "1:1057323137664:web:9df42948bf4a1b4b4a8465",
          measurementId: "G-TFR82FFX8Z"
        };
        
        // --- Firebase Initialization and Auth ---
        let db, auth, userId;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User signed in with ID:", userId);
                    document.getElementById('user-id-display').textContent = userId;
                    loadState();
                } else {
                    console.log("No user signed in. Showing login screen.");
                    showScreen('login-screen');
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showModal('Error', 'Failed to initialize the app. Check the console for details.');
        }

        // --- Authentication Functions ---
        document.getElementById('signup-btn').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorMessageEl = document.getElementById('login-error-message');

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                errorMessageEl.classList.add('hidden');
            } catch (error) {
                errorMessageEl.textContent = error.message;
                errorMessageEl.classList.remove('hidden');
                console.error("Signup error:", error);
            }
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorMessageEl = document.getElementById('login-error-message');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                errorMessageEl.classList.add('hidden');
            } catch (error) {
                errorMessageEl.textContent = error.message;
                errorMessageEl.classList.remove('hidden');
                console.error("Login error:", error);
            }
        });

        document.getElementById('forgot-password-link').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const errorMessageEl = document.getElementById('login-error-message');
            
            if (email) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    errorMessageEl.classList.add('hidden');
                    showModal('Password Reset', 'A password reset link has been sent to your email address.');
                } catch (error) {
                    errorMessageEl.textContent = error.message;
                    errorMessageEl.classList.remove('hidden');
                    console.error("Password reset error:", error);
                }
            } else {
                errorMessageEl.textContent = "Please enter your email to reset your password.";
                errorMessageEl.classList.remove('hidden');
            }
        });

        document.querySelectorAll('[id^="logout-btn"]').forEach(button => {
            button.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // Clear state and local storage on logout
                    localStorage.removeItem('appState');
                    Object.assign(state, {
                        score: 0,
                        questionsAskedCount: 0,
                        difficulty: 'EASY',
                        learningMaterial: '',
                        explanation: '',
                        currentTopic: '',
                    });
                    showScreen('login-screen');
                } catch (error) {
                    console.error("Logout error:", error);
                    showModal('Logout Error', 'Failed to log out. Please try again.');
                }
            });
        });

        // --- Application State and UI Management ---
        const state = {
            currentScreen: 'input',
            difficulty: 'EASY',
            score: 0,
            questionData: null,
            learningMaterial: '',
            explanation: '',
            currentTopic: '',
            learningSpeed: 'standard',
            questionsAskedCount: 0,
            
            // NOTE: Replace this with your actual API key
            // This is for local development only and should not be made public
            apiKey: "AIzaSyDBhGs1xFTVcx653SQ2Gvis80TpnLOWopw" 
        };

        function showScreen(screenId) {
            const screens = ['login-screen', 'welcome-screen', 'topic-screen', 'loading-screen', 'explanation-screen', 'game-screen', 'quiz-results-screen'];
            screens.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            const element = document.getElementById(screenId);
            if (element) {
                element.classList.remove('hidden');
            }
            state.currentScreen = screenId;
        }

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        document.getElementById('modal-ok-btn').addEventListener('click', hideModal);

        // --- Core Application Logic ---
        async function saveState() {
            if (!userId) {
                console.warn("User ID not available. Skipping state save.");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/learningProgress`, 'currentSession');
                await setDoc(docRef, {
                    difficulty: state.difficulty,
                    score: state.score,
                    learningMaterial: state.learningMaterial,
                    explanation: state.explanation,
                    currentTopic: state.currentTopic,
                    learningSpeed: state.learningSpeed,
                    questionsAskedCount: state.questionsAskedCount,
                    timestamp: new Date()
                }, { merge: true });
                console.log("State saved to Firestore.");
            } catch (error) {
                console.error("Error saving state:", error);
                showModal('Error', 'Failed to save your progress. Please check the console.');
            }
        }

        async function loadState() {
            if (!userId) {
                console.warn("User ID not available. Skipping state load.");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/learningProgress`, 'currentSession');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    Object.assign(state, data);
                    console.log("State loaded from Firestore. Resuming session.");
                    updateUI();
                    if(state.questionsAskedCount >= 10) {
                        showQuizResults();
                    } else if(state.explanation) {
                        document.getElementById('explanation-text').innerHTML = state.explanation;
                        showScreen('explanation-screen');
                    } else if (state.learningMaterial) {
                        document.getElementById('curriculum-input').value = state.learningMaterial;
                        showScreen('topic-screen');
                    } else {
                        showScreen('welcome-screen');
                    }
                } else {
                    console.log("No saved state found. Starting new session.");
                    showScreen('welcome-screen');
                }
            } catch (error) {
                console.error("Error loading state:", error);
                showModal('Error', 'Failed to load your progress. Please check the console.');
                showScreen('welcome-screen');
            }
        }
        
        function updateUI() {
            document.getElementById('score-text').textContent = state.score;
            document.getElementById('difficulty-text').textContent = 'Difficulty: ' + state.difficulty;
        }
        
        function renderTreeStructure(text) {
            let html = '<ul class="tree tree-root">';
            let lines = text.split('\n').filter(line => line.trim() !== '');
            let indentStack = [0];

            lines.forEach(line => {
                let indent = line.search(/\S|$/);
                let content = line.trim();

                if (indent > indentStack[indentStack.length - 1]) {
                    html += '<ul>';
                    indentStack.push(indent);
                } else if (indent < indentStack[indentStack.length - 1]) {
                    while (indent < indentStack[indentStack.length - 1]) {
                        html += '</ul></li>';
                        indentStack.pop();
                    }
                }

                if (content.length > 0) {
                    html += `<li>${content}`;
                }
            });

            while (indentStack.length > 1) {
                html += '</ul></li>';
                indentStack.pop();
            }
            html += '</ul>';

            return html;
        }

        async function callGeminiApiWithRetry(payload, retries = 3) {
            const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + state.apiKey;
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        const errorData = await response.json();
                        console.error("API error response:", errorData);
                        if (response.status === 400 || response.status === 403) {
                             throw new Error(`API error: ${errorData.error.message}`);
                        }
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error("API call failed after multiple retries.");
        }

        async function handleMaterialInput() {
            const fileInput = document.getElementById('material-upload');
            const pasteInput = document.getElementById('curriculum-input');
            
            let material = '';
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = async (e) => {
                    material = e.target.result;
                    if (material.trim() === '') {
                        showModal('Input Error', 'Uploaded file is empty.');
                        return;
                    }
                    state.learningMaterial = material;
                    saveState();
                    showScreen('topic-screen');
                };
                reader.onerror = () => {
                    showModal('File Error', 'Failed to read file.');
                };
                reader.readAsText(file);
            } else if (pasteInput.value.trim() !== '') {
                material = pasteInput.value;
                state.learningMaterial = material;
                saveState();
                showScreen('topic-screen');
            } else {
                showModal('Input Error', 'Please upload a file or paste some material to learn from.');
            }
        }

        async function generateExplanationAndQuiz() {
            const topic = document.getElementById('topic-input').value;
            const learningSpeed = document.getElementById('learning-speed').value;
            
            if (topic.trim() === '') {
                showModal('Input Error', 'Please enter a topic to learn about.');
                return;
            }
            state.currentTopic = topic;
            state.learningSpeed = learningSpeed;
            state.difficulty = learningSpeed === 'slow' ? 'EASY' : (learningSpeed === 'fast' ? 'HARD' : 'MEDIUM');

            showScreen('loading-screen');
            
            const systemPrompt = "You are a professional educational platform. Your task is to generate a comprehensive learning package for a specific topic from provided material. This package must include a detailed explanation, a clear markdown-formatted mind map for visual learners, and a step-by-step roadmap for structured learning. Use indentation to create a tree-like structure for the mind map and roadmap. The tone should be tailored to a user who identifies as a '{learningSpeed}' learner. All content must be based on the provided material.";
            const userQuery = `Using the following material, provide a detailed explanation of the topic: ${state.currentTopic}. Also, include a markdown-formatted mind map and a roadmap for learning this topic.
            
            Material:
            ${state.learningMaterial}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt.replace('{learningSpeed}', state.learningSpeed) }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            explanation: { type: "STRING" },
                            mind_map: { type: "STRING" },
                            roadmap: { type: "STRING" }
                        },
                        propertyOrdering: ["explanation", "mind_map", "roadmap"]
                    }
                }
            };
            
            try {
                const responseData = await callGeminiApiWithRetry(payload);
                const data = JSON.parse(responseData);

                state.explanation = `
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Explanation</h3>
                    <p class="mb-6">${data.explanation}</p>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Mind Map</h3>
                    <div class="bg-gray-100 p-4 rounded-lg text-sm mb-6">${renderTreeStructure(data.mind_map)}</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Roadmap</h3>
                    <div class="bg-gray-100 p-4 rounded-lg text-sm">${renderTreeStructure(data.roadmap)}</div>
                `;
                document.getElementById('explanation-text').innerHTML = state.explanation;
                saveState();
                showScreen('explanation-screen');

            } catch (error) {
                console.error("Error generating explanation:", error);
                showModal('API Error', 'Failed to generate explanation. This may be due to the AI having trouble with the topic or material. Please try a different topic or paste different material.');
                showScreen('topic-screen');
            }
        }

        async function handleChatbotQuestion() {
            const chatInput = document.getElementById('chat-input');
            const chatWindow = document.getElementById('chat-window');
            const userQuestion = chatInput.value.trim();
            if (!userQuestion) return;

            const userMessageDiv = document.createElement('div');
            userMessageDiv.textContent = userQuestion;
            userMessageDiv.classList.add('chat-message', 'user-message');
            chatWindow.appendChild(userMessageDiv);
            chatInput.value = '';
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const loadingDiv = document.createElement('div');
            loadingDiv.textContent = 'AI is typing...';
            loadingDiv.classList.add('chat-message', 'ai-message', 'italic', 'text-gray-500');
            chatWindow.appendChild(loadingDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const systemPrompt = "You are a professional and helpful AI tutor. Your role is to answer questions based on the provided learning material and the user's specific topic. Keep your answers concise, accurate, and directly related to the context. If you don't know the answer, politely state that you can only answer questions related to the provided material.";
            const userQuery = `Material: ${state.learningMaterial}\n\nTopic: ${state.currentTopic}\n\nQuestion: ${userQuestion}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const aiAnswer = await callGeminiApiWithRetry(payload);
                chatWindow.removeChild(loadingDiv);
                
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.textContent = aiAnswer || "Sorry, I couldn't process that. Please try again.";
                aiMessageDiv.classList.add('chat-message', 'ai-message');
                chatWindow.appendChild(aiMessageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;

            } catch (error) {
                console.error("Chatbot API error:", error);
                chatWindow.removeChild(loadingDiv);
                showModal('Chatbot Error', 'Failed to get a response from the AI. Please check your connection.');
            }
        }

        async function generateQuizContent() {
            if (state.explanation.trim() === '') {
                 showModal('Quiz Error', 'No explanation found to generate a quiz from.');
                 return;
            }

            if (state.questionsAskedCount >= 10) {
                 showQuizResults();
                 return;
            }

            showScreen('loading-screen');

            const systemPrompt = "You are a professional educational quiz generator. Your task is to create a multiple-choice question based on the provided text. The difficulty of the question should be tailored to the specified difficulty level (EASY, MEDIUM, or HARD). The question must be a direct question, and the options should be plausible. The response must be a valid JSON object.";
            const userQuery = `Using the following explanation, create a ${state.difficulty} difficulty multiple-choice question. The question should be directly from the explanation and its difficulty should match the level. Return a JSON object with 'question', 'options' (an array of 4 strings), and 'answer' (the correct option). Do not provide any text outside of the JSON block.

            Explanation:
            ${state.explanation.replace(/<[^>]*>?/gm, '').replace(/\s+/g, ' ').trim()}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            question: { type: "STRING" },
                            options: {
                                type: "ARRAY",
                                items: { type: "STRING" }
                            },
                            answer: { type: "STRING" }
                        },
                        propertyOrdering: ["question", "options", "answer"]
                    }
                }
            };
            
            try {
                const responseData = await callGeminiApiWithRetry(payload);
                const data = JSON.parse(responseData);
                
                state.questionData = data;
                renderQuestion();
                showScreen('game-screen');
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('total-questions').textContent = `10`;

            } catch (error) {
                console.error("Error generating content:", error);
                showModal('API Error', 'Failed to generate a question. Please try again.');
                showScreen('explanation-screen');
            }
        }

        function renderQuestion() {
            if (!state.questionData) return;

            const questionTextElement = document.getElementById('question-text');
            const optionsContainer = document.getElementById('options-container');

            questionTextElement.textContent = state.questionData.question;
            optionsContainer.innerHTML = '';
            
            state.questionData.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('answer-btn', 'w-full', 'py-3', 'px-4', 'rounded-xl', 'font-medium', 'text-left', 'transition-colors', 'duration-200');
                button.addEventListener('click', () => handleAnswer(option, button));
                optionsContainer.appendChild(button);
            });
        }

        async function handleAnswer(selectedOption, buttonElement) {
            const isCorrect = selectedOption === state.questionData.answer;
            const options = document.getElementById('options-container').querySelectorAll('.answer-btn');
            
            options.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === state.questionData.answer) {
                    btn.classList.add('correct');
                }
                if (btn.textContent === selectedOption && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                state.score += 1;
                const difficultySteps = { 'slow': 3, 'standard': 2, 'fast': 1 };
                if (state.questionsAskedCount % difficultySteps[state.learningSpeed] === 0) {
                    if (state.difficulty === 'EASY') state.difficulty = 'MEDIUM';
                    else if (state.difficulty === 'MEDIUM') state.difficulty = 'HARD';
                }
            } else {
                const difficultySteps = { 'slow': 1, 'standard': 2, 'fast': 3 };
                if (state.questionsAskedCount % difficultySteps[state.learningSpeed] === 0) {
                    if (state.difficulty === 'HARD') state.difficulty = 'MEDIUM';
                    else if (state.difficulty === 'MEDIUM') state.difficulty = 'EASY';
                }
            }
            
            state.questionsAskedCount++;
            updateUI();
            
            if (state.questionsAskedCount < 10) {
                document.getElementById('next-btn').classList.remove('hidden');
            } else {
                showQuizResults();
            }
        }

        function drawScoreGraph(score, total) {
            const canvas = document.getElementById('score-chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const scorePercentage = (score / total);
            const barHeight = height * 0.5;
            const barWidth = width * 0.8;
            const barX = (width - barWidth) / 2;
            const barY = (height - barHeight) / 2;

            ctx.clearRect(0, 0, width, height);

            ctx.fillStyle = '#5a3c1e';
            ctx.fillRect(barX, barY, barWidth, barHeight);
            
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(barX, barY, barWidth * scorePercentage, barHeight);

            ctx.fillStyle = '#f5f5dc';
            ctx.font = '24px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`${score} / ${total}`, width / 2, height / 2);
        }

        async function showQuizResults() {
            showScreen('quiz-results-screen');
            
            const scorePercentage = (state.score / 10) * 100;
            document.getElementById('final-score-text').textContent = `${state.score} / 10`;
            drawScoreGraph(state.score, 10);

            const performanceMessageEl = document.getElementById('performance-message');
            const suggestionsEl = document.getElementById('suggestions');
            suggestionsEl.innerHTML = '';
            
            if (scorePercentage >= 60) {
                performanceMessageEl.textContent = "Congratulations! You've done a great job!";
                
                const systemPrompt = "You are a professional educational platform. Based on the provided learning material and the user's current topic, suggest the next logical topic to study or a related advanced concept. Provide a brief, encouraging paragraph (3-4 sentences).";
                const userQuery = `Learning Material: ${state.learningMaterial}\n\nCurrent Topic: ${state.currentTopic}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                try {
                    const suggestionText = await callGeminiApiWithRetry(payload);
                    suggestionsEl.innerHTML = `<p>${suggestionText}</p>`;
                } catch(error) {
                    console.error("Error getting suggestions:", error);
                    suggestionsEl.innerHTML = `<p>Failed to get a suggestion from the AI. Check the console for errors.</p>`;
                }

            } else {
                performanceMessageEl.textContent = "It looks like you could use a little more practice.";
                suggestionsEl.innerHTML = `<p class="mb-4">Here are some resources to help you master this topic. Try searching for these on YouTube or Google:</p>`;
                
                const searchQueries = [`YouTube tutorial on ${state.currentTopic}`, `articles to learn ${state.currentTopic}`];
                const ul = document.createElement('ul');
                ul.classList.add('list-disc', 'list-inside', 'space-y-2');
                
                searchQueries.forEach(query => {
                    const li = document.createElement('li');
                    li.textContent = query;
                    ul.appendChild(li);
                });
                suggestionsEl.appendChild(ul);
            }

            localStorage.removeItem('appState');
            state.score = 0;
            state.questionsAskedCount = 0;
            state.difficulty = 'EASY';
            state.learningMaterial = '';
            state.explanation = '';
            state.currentTopic = '';
        }

        // --- Event Listeners ---
        document.getElementById('start-btn').addEventListener('click', handleMaterialInput);
        document.getElementById('get-explanation-btn').addEventListener('click', generateExplanationAndQuiz);
        document.getElementById('start-quiz-btn').addEventListener('click', generateQuizContent);
        document.getElementById('next-btn').addEventListener('click', generateQuizContent);
        document.getElementById('send-chat-btn').addEventListener('click', handleChatbotQuestion);
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleChatbotQuestion();
        });
        document.getElementById('start-over-btn').addEventListener('click', () => {
            showScreen('input-screen');
        });

        window.onload = loadState;
    </script>
</body>
</html>

